<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="style.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<title>CTA Information Dashboard</title>
		<meta charset="UTF-8" />
	</head>
	<body>
		<h1>CTA Information</h1>
		<div id="weather-section" class="weather-section">
			<i class="fa-regular fa-cloud cta-logo"></i>
			<h2>Weather</h2>
			<div id="weather-info">
			  <img id="weather-icon" src="" alt="Weather Icon" class="weather-img"/>
			  <p id="weather-description" class="text"></p>
			  <p id="temperature" class="text"></p>
			</div>
		</div>
		<br/>
		<br/>
		<br/>
		<br/>
		<br/>
		<div class="train-section">
			<br/>
			<img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Chicago_Transit_Authority_Logo.svg" class="cta-logo"/>
			<h2>Trains</h2>
		<!-- </div> -->
		<!-- <div id="section-container"> -->
			<table id="train-table">
				<thead>
				<tr>
					<th>Station</th>
					<th>Destination</th>
					<th>Arrival Time</th>
				</tr>
				</thead>
				<tbody id="train-list"></tbody>
			</table>
			<br/>
		</div>
	</body>
	<script>
		fetch('api/weather')
			.then(response => response.json())
			.then(data => {
				const weatherIcon = document.getElementById('weather-icon');
				const weatherDescription = document.getElementById('weather-description');
				const temperature = document.getElementById('temperature');
				const humidity = document.getElementById('humidity');

				// Update HTML with weather information
				weatherIcon.src = data.current.condition.icon;
				weatherDescription.textContent = data.current.condition.text;
				temperature.textContent = `${data.current.temp_f} Â°F`;
			})
			.catch(error => {
				console.error('Error fetching weather data:', error);
			});

		fetch('/api')
		  .then(response => response.json())
		  .then(data => {
			const dataContainer = document.getElementById('train-list');
			const trainsByStation = {};

			if (!data || !Array.isArray(data)) {
				console.error('Invalid data received from server:', data);
				return;
			}
			
			data.forEach(responseData => {
				if (!responseData || !responseData.ctatt || !responseData.ctatt.eta || !Array.isArray(responseData.ctatt.eta)) {
					console.error('Invalid response data format:', responseData);
					return;
				}
				responseData.ctatt.eta.forEach(eta => {
					const staName = eta.staNm;
					const destName = eta.destNm;
					const route = eta.rt;
					const arrT = eta.arrT;

					const key = `${destName}_${route}`;

					if (!trainsByStation[key]) {
						trainsByStation[key] = [];
					}
					
					trainsByStation[key].push({ staName, destName, arrT, route })
				});
			});

			let currentIndex = 0;
			const displayLimit = 5;
			const displayNextTrains = () => {
				const keys = Object.keys(trainsByStation);
				const endIndex = currentIndex + displayLimit;
				const trainsToShow = keys.slice(currentIndex, endIndex).map(key => trainsByStation[key]).flat().slice(0, displayLimit);

				if (trainsToShow.length === 0) {
					currentIndex = 0;
				}

				const existingRows = Array.from(dataContainer.children);
				const rowsToRemove = existingRows.filter(row => !trainsToShow.includes(row.train));

				rowsToRemove.forEach(row => {
					row.classList.add('fade-out');
					// setTimeout(() => {
					// 	dataContainer.removeChild(row);
					// }, 500);
				});

				dataContainer.innerHTML = '';

				trainsToShow.forEach(train => {
					if (!existingRows.some(row => row.train === train)) {
						const row = document.createElement('tr');
						const routeCell = document.createElement('td');
						const destCell = document.createElement('td');
						const arrTCell = document.createElement('td');

						routeCell.textContent = train.staName;
						destCell.textContent = train.destName;
						arrTCell.textContent = getTimeUntilArrival(train.arrT);

						row.classList.add(`route-${train.route}`, `fade-in`);

						row.appendChild(routeCell);
						row.appendChild(destCell);
						row.appendChild(arrTCell);

						dataContainer.appendChild(row);
					}
				});
				currentIndex = (currentIndex + displayLimit) % keys.length;
				setTimeout(displayNextTrains, 10000);
			};
			displayNextTrains();
		})
	
		.catch(error => {
			console.error('Error fetching API data:', error);
		});

		function getTimeUntilArrival(arrivalTime) {
			const now = new Date();
			const arrival = new Date(arrivalTime);
			const diff = Math.floor((arrival - now) / 1000);

			const minutes = Math.floor(diff / 60);
			if (minutes <= 0) {
				return 'Due';
			} else {
				return `${minutes} minutes`;
			}
		}

	  </script>
</html>