<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="style.css" />
		<title>ELK Transit Dashboard</title>
		<meta charset="UTF-8" />
	</head>
	<body>
		<h1>CTA Information</h1>
		<img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Chicago_Transit_Authority_Logo.svg" class="cta-logo"/>
		<h2>Trains</h2>
		<table id="train-table">
			<thead>
			  <tr>
				<th>Station</th>
				<th>Destination</th>
				<th>Arrival Time</th>
			  </tr>
			</thead>
			<tbody id="train-list"></tbody>
		</table>
	</body>
	<script>
		fetch('/api')
		  .then(response => response.json())
		  .then(data => {
			const dataContainer = document.getElementById('train-list');
			const trainsByStation = {};

			if (!data || !Array.isArray(data)) {
				console.error('Invalid data received from server:', data);
				return;
			}
			
			data.forEach(responseData => {
				if (!responseData || !responseData.ctatt || !responseData.ctatt.eta || !Array.isArray(responseData.ctatt.eta)) {
					console.error('Invalid response data format:', responseData);
					return;
				}
				responseData.ctatt.eta.forEach(eta => {
					const staName = eta.staNm;
					const destName = eta.destNm;
					const route = eta.rt;
					const arrT = eta.arrT;

					const key = `${destName}_${route}`;

					if (!trainsByStation[key]) {
						trainsByStation[key] = [];
					}
					
					trainsByStation[key].push({ staName, destName, arrT, route })
				});
			});

			let currentIndex = 0;
			const displayLimit = 5;
			const displayNextTrains = () => {
				const keys = Object.keys(trainsByStation);
				const endIndex = currentIndex + displayLimit;
				const trainsToShow = keys.slice(currentIndex, endIndex).map(key => trainsByStation[key]).flat().slice(0, displayLimit);

				if (trainsToShow.length === 0) {
					currentIndex = 0;
				}

				dataContainer.innerHTML = '';

				trainsToShow.slice(0, displayLimit).forEach(train => {
					const row = document.createElement('tr');
					const routeCell = document.createElement('td');
					const destCell = document.createElement('td');
					const arrTCell = document.createElement('td');

					routeCell.textContent = train.staName;
					destCell.textContent = train.destName;
					arrTCell.textContent = getTimeUntilArrival(train.arrT);

					row.classList.add(`route-${train.route}`);

					row.appendChild(routeCell);
					row.appendChild(destCell);
					row.appendChild(arrTCell);

					dataContainer.appendChild(row);
				});
				currentIndex = (currentIndex + displayLimit) % keys.length;
				setTimeout(displayNextTrains, 5000);
			};
			displayNextTrains();
		})
	
		.catch(error => {
			console.error('Error fetching API data:', error);
		});

		function getTimeUntilArrival(arrivalTime) {
			const now = new Date();
			const arrival = new Date(arrivalTime);
			const diff = Math.floor((arrival - now) / 1000);

			const minutes = Math.floor(diff / 60);
			if (minutes <= 0) {
				return 'Due';
			} else {
				return `${minutes} minutes`;
			}
		}

	  </script>
</html>