<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="style.css" />
		<title>ELK Transit Dashboard</title>
		<meta charset="UTF-8" />
	</head>
	<body>
		<h1>CTA Information</h1>
		<img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Chicago_Transit_Authority_Logo.svg" class="cta-logo"/>
		<h2>Trains</h2>
		<table id="train-table">
			<thead>
			  <tr>
				<th>Route</th>
				<th>Destination</th>
				<th>Arrival Time</th>
			  </tr>
			</thead>
			<tbody id="train-list"></tbody>
		</table>
	</body>
	<script>
		fetch('/api')
		  .then(response => response.json())
		  .then(data => {
			const dataContainer = document.getElementById('train-list');
			const trainsByStation = {};

			if (!data || !Array.isArray(data)) {
				console.error('Invalid data received from server:', data);
				return;
			}
			
			data.forEach(responseData => {
				if (!responseData || !responseData.ctatt || !responseData.ctatt.eta || !Array.isArray(responseData.ctatt.eta)) {
					console.error('Invalid response data format:', responseData);
					return;
				}
				responseData.ctatt.eta.forEach(eta => {
					const row = document.createElement('tr');
					const routeCell = document.createElement('td');
					const destCell = document.createElement('td');
					const arrTCell = document.createElement('td');

					const staName = eta.staNm;
					const destName = eta.destNm;
					const route = eta.rt;
					const arrT = eta.arrT;
					const currTime = new Date();
					const arrTime = new Date(arrT);
					const timeDiff = Math.ceil((arrTime - currTime) / (1000 * 60));
					const routeItem = document.createElement('li');

					if (!trainsByStation[staName]) {
						trainsByStation[staName] = {};
					}

					if (!trainsByStation[staName][route]) {
						trainsByStation[staName][route] = [];
					}

					trainsByStation[staName][route].push({ destName, arrT });

					row.classList.add(`route-${route}`);
				});
			});

			for (const staName in trainsByStation) {
				for (const route in trainsByStation[staName]) {
					const trains = trainsByStation[staName][route];
					const sortedTrains = trains.sort((a, b) => new Date(a.arrT) - new Date(b.arrT)).slice(0, 2);

					sortedTrains.forEach(train => {
						
						const arrT = train.arrT;
						const destName = train.destName;

						const row = document.createElement('tr');
						const routeCell = document.createElement('td');
						const destCell = document.createElement('td');
						const arrTCell = document.createElement('td');

						routeCell.textContent = staName;
						destCell.textContent = destName;
						arrTCell.textContent = getTimeUntilArrival(arrT);

						row.classList.add(`route-${route}`);

						row.appendChild(routeCell);
						row.appendChild(destCell);
						row.appendChild(arrTCell);

						dataContainer.appendChild(row);
					});
				}
			}


		  })
		  .catch(error => {
			console.error('Error fetching API data:', error);
		  });

		function getTimeUntilArrival(arrivalTime) {
			const now = new Date();
			const arrival = new Date(arrivalTime);
			const diff = Math.floor((arrival - now) / 1000);

			const minutes = Math.floor(diff / 60);
			if (minutes <= 0) {
				return 'Due';
			} else {
				return `${minutes} minutes`;
			}
		}

	  </script>
</html>